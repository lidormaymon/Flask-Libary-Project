<!DOCTYPE html>
<html lang="en">

<head>
    <style>
        input {
            width: 100%;
            height: 45px;
            border-radius: 30px;
        }


        .MSG {
            font-size: 20px;
            font-family: Arial, Helvetica, sans-serif;
            position: relative;
            top: 30px;
            text-align: center;
        }


        #search-loan-book {
            display: none;
        }

        .searchBox {
            height: 50px;
            width: 15px;
        }


        .checkbox-container {
            display: flex;
        align-items: center;
        }

        .checkbox-container label {
        margin-right: 10px;
        }
    </style>
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.8/css/line.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.0.1/css/toastr.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../styles.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loans</title>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>
</head>

<body>
    <header>
        <nav>
            <ul>
                <ul>
                    <li><a href="../../index.html">Home</a></li>
                    <li><a href="../books/booksH.html">Books</a></li>
                    <li><a href="../customers/customersH.html">Customers</a></li>
                    <li><a href="loans.H.html">Loans</a></li>
                </ul>
        </nav>
        <div class="subnavbar">
            <ul>
                <li><a href="loans.H.html">List</a></li>
                <li><a href="loanbook.html">Loan</a></li>
                <li><a href="active_loans.html">Active Loans</a></li>
                <li><a href="expiredLoans.html">Expired Loans</a></li>
            </ul>
        </div>
    </header>
    <h1>View all loans(Active loans, and returned)</h1>
    <div class="title">Search loan:</div><br>
    <div>Select the filter you wish to use:</div>
    <div class="checkbox-container">
        <input type="radio" id="searchCustomerBox" onchange="checkBox()" class="searchBox" name="searchBox"><!--Giving it name so it wouldn't be able to check both of them -->
        <label for="searchID">Customer</label>
        <input type="radio" id="searchBookBox"onchange="checkBox()"  class="searchBox" name="searchBox">
        <label for="searchID">Book</label>
    </div>
    <input id="search-loan-customer" placeholder="Search customer name..." type="search" oninput="searchLoanCustomer()">
    <input id="search-loan-book" placeholder="Search book name..." type="search" oninput="searchLoanBook()"><br>
    <div id="searchMSG"></div>
    <div class="title" id="count_loans"></div>
    <div id="loansDisplay"></div>



    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.0.1/js/toastr.min.js"></script>
     <!--NOTE: SCRIPT ENTRY!!!-->
    <script>
        const MY_SERVER = 'https://flask-libarly-sql-alchemy.onrender.com'
        const showLoans = async () => {
        const loansResponse = await axios.get(MY_SERVER + '/show-loans');
        const loansData = loansResponse.data;
        
        const loansDisplay = document.getElementById('loansDisplay');
        loansDisplay.innerHTML = `
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Customer Name</th>
                    <th>Book Name</th>
                    <th>Loan Date</th>
                    <th>Return Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                ${loansData.map((loan) =>  `
                    <tr>
                        <td>${loan.id}</td>
                        <td>${loan.customer_name}</td>
                        <td>${loan.book_name}</td>
                        <td>${loan.loandate}</td>
                        <td>${loan.returndate}</td>
                        <td>${loan.status}</td>
                    </tr>
                `).join("")}
            </tbody>
        </table>`
        };


        showLoans()

        const countLoans = async () => {
            const count = await axios.get(MY_SERVER + '/show-loans')
            count_loans.innerHTML = `Loans record:${count.data.length}`
        }

        countLoans()


        //SEARCH LOANS FUNCTION
            //CHECKBOX FUNCTIONS
            const checkBox = () => {
                const searchCustomerBox = document.getElementById('searchCustomerBox')
                const searchBookBox = document.getElementById('searchBookBox')

                const searchBook = document.getElementById('search-loan-book')
                const searchCustomer = document.getElementById('search-loan-customer')
                if (searchCustomerBox.checked) {
                    searchBook.style.display = 'none'
                    searchCustomer.style.display = 'block'
                    showLoans()
                }else if(searchBookBox.checked) {
                    searchCustomer.style.display = 'none'
                    searchBook.style.display = 'block'
                    showLoans()
                }}

            
            //Searching cucstomer function
            const searchLoanCustomer = async () => {
                const searchCustomerCap = document.getElementById('search-loan-customer');
                const searchCustomer = searchCustomerCap.value.toLowerCase();
                const response = await axios.get(`${MY_SERVER}/search-loan-customer?search=${searchCustomer}`);
                const filteredData = response.data;

                
                //Checking if the input value exist in the database
                if (filteredData.some(loan =>
                    loan.customername.toLowerCase().includes(searchCustomer)
                )) {
                    loansDisplay.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Customer Name</th>
                            <th>Book Name</th>
                            <th>Loan Date</th>
                            <th>Return Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredData
                            .map(
                                loan => `
                                    <tr>
                                        <td>${loan.id}</td>
                                        <td>${loan.customername}</td>
                                        <td>${loan.bookname}</td>
                                        <td>${loan.loandate}</td>
                                        <td>${loan.returndate}</td>
                                        <td>${loan.status}</td>
                                    </tr>`
                            )
                            .join('')}
                    </tbody>
                </table>`;
                    searchMSG.innerHTML = ''; // Clear any previous "Book not found" message
                } else {
                    // No books found, display a message
                    loansDisplay.innerHTML = '';
                    searchMSG.innerHTML = 'Book not found';
                    searchMSG.style.color = 'red';
                }
            }

            //Search book function
            const searchLoanBook = async () => {
                const searchBookCap = document.getElementById('search-loan-book');
                const searchBook = searchBookCap.value.toLowerCase();

                const response = await axios.get(`${MY_SERVER}/search-loan-book?search=${searchBook}`);
                const filteredData = response.data;

                
                //Checking if the input value exist in the database
                if (filteredData.some(loan =>
                    loan.bookname.toLowerCase().includes(searchBook)
                )) {
                    loansDisplay.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Customer Name</th>
                            <th>Book Name</th>
                            <th>Loan Date</th>
                            <th>Return Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredData
                            .map(
                                loan => `
                                    <tr>
                                        <td>${loan.id}</td>
                                        <td>${loan.customername}</td>
                                        <td>${loan.bookname}</td>
                                        <td>${loan.loandate}</td>
                                        <td>${loan.returndate}</td>
                                        <td>${loan.status}</td>
                                    </tr>`
                            )
                            .join('')}
                    </tbody>
                </table>`;
                    searchMSG.innerHTML = ''; // Clear any previous "Book not found" message
                } else {
                    // No books found, display a message
                    loansDisplay.innerHTML = '';
                    searchMSG.innerHTML = 'Book not found';
                    searchMSG.style.color = 'red';
                }
            }
    </script>
</body>
</html>